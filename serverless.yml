service: bytabit-serverless

provider:
  name: aws
  runtime: nodejs8.10
  stage: test

  environment:
      OFFER_TABLE: ${self:service}-${opt:stage, self:provider.stage}-offer
      TRADE_TABLE: ${self:service}-${opt:stage, self:provider.stage}-trade

  iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
          - dynamodb:Scan
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
          - dynamodb:DeleteItem
        Resource:
          - "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.OFFER_TABLE}"
          - "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRADE_TABLE}"
          - "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRADE_TABLE}/index/sellerIndex"
          - "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRADE_TABLE}/index/buyerIndex"
          - "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/${self:provider.environment.TRADE_TABLE}/index/arbitratorIndex"

functions:
  offers-create:
      handler: src/main/js/offer/create.create
      events:
        - http:
            path: offers/{sellerEscrowPubKey}
            method: put
            cors: true
  offers-list:
      handler: src/main/js/offer/list.list
      events:
        - http:
            path: offers
            method: get
            cors: true
  offers-delete:
      handler: src/main/js/offer/delete.delete
      events:
        - http:
            path: offers/{sellerEscrowPubKey}
            method: delete
            cors: true
  trades-create:
      handler: src/main/js/trade/create.create
      events:
        - http:
            path: trades/{escrowAddress}
            method: put
            cors: true
  trades-list:
      handler: src/main/js/trade/list.list
      events:
        - http:
            path: trades
            method: get
            cors: true

resources:
  Resources:

    BytabitOfferTable:
          Type: 'AWS::DynamoDB::Table'
          DeletionPolicy: Delete
          Properties:
            TableName: ${self:provider.environment.OFFER_TABLE}
            AttributeDefinitions:
              -
                AttributeName: sellerEscrowPubKey
                AttributeType: S
            KeySchema:
              -
                AttributeName: sellerEscrowPubKey
                KeyType: HASH
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1

    BytabitTradeTable:
          Type: 'AWS::DynamoDB::Table'
          DeletionPolicy: Delete
          Properties:
            TableName: ${self:provider.environment.TRADE_TABLE}
            AttributeDefinitions:
              -
                AttributeName: escrowAddress
                AttributeType: S
              -
                AttributeName: version
                AttributeType: N
              -
                AttributeName: sellerProfilePubKey
                AttributeType: S
              -
                AttributeName: buyerProfilePubKey
                AttributeType: S
              -
                AttributeName: arbitratorProfilePubKey
                AttributeType: S
            KeySchema:
              -
                AttributeName: escrowAddress
                KeyType: HASH
              -
                AttributeName: version
                KeyType: RANGE
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1
            GlobalSecondaryIndexes:
              -
                IndexName: sellerIndex
                KeySchema:
                  -
                    AttributeName: sellerProfilePubKey
                    KeyType: HASH
                  -
                    AttributeName: escrowAddress
                    KeyType: RANGE
                Projection:
                  ProjectionType: ALL
                ProvisionedThroughput:
                  ReadCapacityUnits: "1"
                  WriteCapacityUnits: "1"
              -
                IndexName: buyerIndex
                KeySchema:
                  -
                    AttributeName: buyerProfilePubKey
                    KeyType: HASH
                  -
                    AttributeName: escrowAddress
                    KeyType: RANGE
                Projection:
                  ProjectionType: ALL
                ProvisionedThroughput:
                  ReadCapacityUnits: "1"
                  WriteCapacityUnits: "1"
              -
                IndexName: arbitratorIndex
                KeySchema:
                  -
                    AttributeName: arbitratorProfilePubKey
                    KeyType: HASH
                  -
                    AttributeName: escrowAddress
                    KeyType: RANGE
                Projection:
                  ProjectionType: ALL
                ProvisionedThroughput:
                  ReadCapacityUnits: "1"
                  WriteCapacityUnits: "1"

plugins:
  - serverless-domain-manager

custom:
  customDomain:
    domainName: ${opt:stage, self:provider.stage}.bytabit.net
    basePath: ''
    stage: ${opt:stage, self:provider.stage}
    createRoute53Record: true